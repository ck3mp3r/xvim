# https://numtide.github.io/devshell
name = "xvim devshell"

packages = [
  "alejandra",
  "lua-language-server",
  "nixd",
  "nodePackages_latest.bash-language-server",
  "pre-commit",
  "stylua"
]

[[commands]]
name = "checks"
help = "Run Neovim health check via nix run"
command = '''
#!/bin/bash

set -e

echo "üîç Running Neovim diagnostics..."

# Test configuration with verbose output
echo "Testing configuration..."
startup_log=$(nix run .# -- --headless -V1 +quit 2>&1)

if echo "$startup_log" | grep -qi "error\|failed\|cannot load\|could not load\|cannot find"; then
    echo "‚ùå Configuration errors:"
    echo "$startup_log" | grep -i -A2 -B1 "error\|failed\|cannot load\|could not load\|cannot find"
    exit 1
fi

# Run health check
echo "Running health check..."
health_log=$(nix run .# -- --headless +checkhealth +quit 2>&1)
echo "$health_log"

if echo "$health_log" | grep -qi "error\|failed"; then
    echo "‚ùå Health check failed"
    exit 1
fi

echo "‚úÖ All checks passed!"'''

[git.hooks]
enable = true

[git.hooks.pre-push]
text = '''
pre-commit run --all-files
nix flake check
checks
'''
